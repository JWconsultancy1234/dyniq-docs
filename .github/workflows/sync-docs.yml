name: Sync Docs from Source Repos

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated repos to sync (empty = all)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run (no PR created)'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [docs-sync]

concurrency:
  group: sync-docs
  cancel-in-progress: true

env:
  SYNC_BRANCH: auto/sync-docs

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout dyniq-docs
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Checkout walker-os
        uses: actions/checkout@v4
        with:
          repository: JWconsultancy1234/walker-os
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: _sources/walker-os
          sparse-checkout: |
            .claude/commands
            .claude/reference
            .agents/sops
            README.md
            ARCHITECTURE.md

      - name: Checkout dyniq-ai-agents
        uses: actions/checkout@v4
        with:
          repository: JWconsultancy1234/dyniq-ai-agents
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: _sources/dyniq-ai-agents
          sparse-checkout: |
            docs
            README.md

      - name: Checkout dyniq-app
        uses: actions/checkout@v4
        with:
          repository: JWconsultancy1234/dyniq-app
          token: ${{ secrets.CROSS_REPO_PAT }}
          path: _sources/dyniq-app
          sparse-checkout: |
            README.md
            ARCHITECTURE.md

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run sync transform
        run: bash scripts/sync-docs.sh

      - name: Validate build before PR
        run: |
          echo "::group::Spell check (synced content)"
          npx cspell "docs/**/*.md" --no-progress || echo "::warning::Spell check found issues"
          echo "::endgroup::"
          echo "::group::Build validation"
          npm run build
          echo "::endgroup::"
          echo "Build passed - synced content is deployable"

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No documentation changes detected"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            git diff --cached --stat
          fi

      - name: Create sync PR
        if: steps.changes.outputs.has_changes == 'true' && !inputs.dry_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or reset sync branch
          git checkout -B "$SYNC_BRANCH"
          git commit -m "docs: auto-sync from source repos $(date +%Y-%m-%d)"

          git push -f origin "$SYNC_BRANCH"

          # Create PR if one doesn't exist
          EXISTING_PR=$(gh pr list --head "$SYNC_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "docs: auto-sync from source repos $(date +%Y-%m-%d)" \
              --body "$(cat <<'EOF'
          ## Auto-Sync from Source Repos

          This PR was automatically generated by the doc sync pipeline.
          Build validation passed before PR creation.

          **Sources synced:**
          - `walker-os` (.claude/commands, .claude/reference, .agents/sops)
          - `dyniq-ai-agents` (docs/, README)
          - `dyniq-app` (README, ARCHITECTURE)

          **Review:** Check that frontmatter is correct and no sensitive data was synced.

          _Generated by `.github/workflows/sync-docs.yml`_
          EOF
          )" \
              --head "$SYNC_BRANCH" \
              --base main \
              --label "Documentation"
          else
            echo "PR #$EXISTING_PR already exists, force-pushed updates"
          fi

      - name: Auto-merge when CI passes
        if: steps.changes.outputs.has_changes == 'true' && !inputs.dry_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(gh pr list --head "$SYNC_BRANCH" --json number --jq '.[0].number')
          if [ -n "$PR_NUM" ]; then
            gh pr merge "$PR_NUM" --auto --squash || echo "::warning::Auto-merge not enabled or PR not ready"
          fi

      - name: Cleanup sources
        if: always()
        run: rm -rf _sources
